<!DOCTYPE html>

<html>
<head>
    <title>GeneSpot Results</title>
    <!-- firebase.js -->
    <script src="https://www.gstatic.com/firebasejs/3.7.6/firebase.js"></script>
    <!-- Hosted GeneSpot JS files -->
    <script src="results.js"></script>
    <script src="resultsCookies.js"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
<!-- Generic GeneSpot Header -->
<div style="text-align: center" id="project-header">
    <img src="evolution.jpg" alt="Evolution" style="width: 300px; height: 150px;">
    <h1>The GeneSpot</h1>
    <p><i>Bioinformatics and Evolutionary Biology Tool </i></p>
    <br>
    <br />
</div>

<!-- Display Job Info -->
<h2>GeneSpot Alignment and Scoring Results for Job: <span id="insertjn"></span></h2>

<div id="resultTable">
    <!-- Plotly chart will be drawn inside this DIV -->
</div>

<div id="testarea"></div>
<div id="testarea1"></div>
<br />
<br />
<div id="testarea2"></div>

<script>
    //store jobname locally to insert into html and use as reference in firebase
    var jname = getCookie("cJobName");
    document.getElementById("insertjn").innerHTML = jname;

    //configure connection to firebase
    var config = {
        apiKey: "AIzaSyCvLxY6fjWaS2BNaYjsVlFoj-368w8V-1s",
        authDomain: "thegenespot-efb8a.firebaseapp.com/",
        databaseURL: "https://thegenespot-efb8a.firebaseio.com",
        projectId: "thegenespot-efb8a",
        storageBucket: "thegenespot-efb8a.appspot.com"
        //messagingSenderId: "139442074898"
    };
    firebase.initializeApp(config); //connect web app to database

    //test for localStorage availability and access
    if (storageAvailable('localStorage')) {
        // Yippee! We can use localStorage awesomeness
    }
    else if (storageAvailable('sessionStorage')) {
        // okay
        alert("Session storage is erased when the window is closed.");
    }
    else {
        alert("Either your browser is outdated, or something is blocking us from saving your job info :(");
    }


    //reference job parent node
    var node = firebase.database().ref(jname);

    //establish variables
    var jobInfoByGene = [];
    var jobString = "";
    //counters
    var geneCount = 0;
    var assemblyCount = 0;
    //may need to move into function? shouldn't matter if only used in snapshot function -> would be nice to use elsewhere

    var value = node.once('value').then(function(snapshot){     // value == Firebase 'Promise'
        jobString = JSON.stringify(snapshot.toJSON());      // jobString == JSON String of entire Job
        //console.log(jobObject);
        snapshot.forEach(function (geneLevel) {

            var tg = geneLevel.key;

            geneLevel.forEach(function (kingdomLevel){

                var tk = kingdomLevel.key;

                kingdomLevel.forEach(function (typeLevel){

                    var tt = typeLevel.key;

                    typeLevel.forEach(function(idLevel){

                        var ti = idLevel.key;

                        idLevel.forEach(function (assemblyLevel) {

                            var ta = assemblyLevel.key;
                            var tha = [];
                            //var thc = assemblyLevel.numChildren();
                            assemblyLevel.forEach(function (hitLevel){

                                tha.push(hitLevel.val());

                            }); // END HIT LEVEL

                            var th = new HitInformation(tha);
                            var tgi = new CellInformation(tg,tk,tt,ti,ta,th);
                            //console.log(tgi);
                            var tempCell = JSON.stringify(tgi);
                            // print internal cellInfo to console ----> want external
                            //console.log(JSON.parse(tempCell));
                            //console.log(tempCell);

                            //reference global jobInfoByGene array
                            jobInfoByGene.push(tempCell);
                            //currently pushing to local array

                            /*
                            var jobArrayRef = window.jobInfoByGene;
                            if ((jobArrayRef.length) !== 0){
                                window.jobInfoByGene.push(tempCell); // error caught in promise -- no 'push' firebase function
                            } else {
                                window.jobInfoByGene = tempCell;
                            }
                            */

                            //console.log("assemblyCount: "+assemblyCount);
                            console.log(JSON.parse(jobInfoByGene[assemblyCount]));  // local jobInfoByGene, local assemblyCount
                            // remove JSON.parse here

                        }); // END ASSEMBLY LEVEL
                        //increment assembly counter
                        assemblyCount++;
                    });
                });
            }); // END KINGDOM LEVEL

            geneCount++;

        }); // END of snapshot.forEach geneLevel

    });

    //TODO: fix hoisting of jobInfoByGene Array (line 114)
    //console.log("Global jobInfoByGene Array length: "+window.jobInfoByGene.length);
    //for parsing here:

    //then complete functions pulling out values to plotly arrays


    /* Draw Plot --- Draw Plot --- Draw Plot --- ------------------- --- Draw Plot --- Draw Plot --- Draw Plot */

    // HARD-CODED TEST DATA
    //----------------------
    hitCount = [[2, 1],[7, 5]];
    var gene = ['Rad51', 'Dmc1'];
    species = ['Mus', 'Fish'];
    //---------------------


    //build data for plotly
    var maxScores, gNames, orgNames = [];

/*    maxScores = [Number(tempit['hitInfo']['hitAmal'][0]['max'])];
    gNames = tempit['geneName'];
    orgNames = tempit['kingdom']+": "+tempit['subtype'];
    //insert data
    var data = [{
        z: maxScores,
        x: gNames,
        y: orgNames,
        type: 'heatmap',
        showscale: true
    }];
*/
    var data = [{
      z: hitCount,
      x: gene,
      y: species,
      type: 'heatmap',
      showscale: true
    }];

    //Configure plot/table layout
    var layout = {
        title: '"'+jname.toString()+'" GeneSpot Results',
        font: {
            family: 'Arial',
            size: 18
        },
        annotations: [],
        xaxis: {
          ticks: '',
          side: 'top'
        },
        yaxis: {
          ticks: '',
          ticksuffix: ' '
        }
      };

    // draw resultTable
    Plotly.newPlot('resultTable', data, layout);

</script>

</body>
</html>
